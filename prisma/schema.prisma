// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(uuid())
  firebaseUid       String    @unique
  email             String    @unique
  role              UserRole  @default(GUEST)
  
  // Profile
  firstName         String
  lastName          String
  dateOfBirth       DateTime
  phoneNumber       String?
  bio               String?
  profileImageUrl   String?
  screenName        String?
  genderIdentity    String?
  relationshipStatus String?
  location          String?
  inviteCode        String?
  
  // Verification & Trust
  emailVerified     Boolean   @default(false)
  phoneVerified     Boolean   @default(false)
  identityVerified  Boolean   @default(false)
  identityProvider  String?
  identityVerifiedAt DateTime?
  
  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?
  
  // Relations
  ownedRentals      Rental[]  @relation("HostRentals")
  bookings          Booking[] @relation("GuestBookings")
  reviewsWritten    Review[]  @relation("ReviewAuthor")
  reviewsReceived   Review[]  @relation("ReviewSubject")
  
  // Messaging
  conversationsOne  Conversation[] @relation("ParticipantOne")
  conversationsTwo  Conversation[] @relation("ParticipantTwo")
  messagesSent      Message[]      @relation("MessageSender")
  
  @@index([email])
  @@index([firebaseUid])
  @@index([role])
}

enum UserRole {
  GUEST
  HOST
  ADMIN
}

model Rental {
  id                String    @id @default(uuid())
  hostId            String
  
  // Basic Info
  title             String
  description       String
  propertyType      PropertyType
  
  // Location
  addressLine1      String
  addressLine2      String?
  city              String
  state             String
  zipCode           String
  country           String   @default("US")
  latitude          Float?
  longitude         Float?
  
  // Capacity & Rules
  maxGuests         Int
  bedrooms          Int
  bathrooms         Float
  minimumAge        Int      @default(21)
  
  // Pricing
  pricePerNight     Decimal  @db.Decimal(10, 2)
  cleaningFee       Decimal? @db.Decimal(10, 2)
  securityDeposit   Decimal? @db.Decimal(10, 2)
  
  // Amenities (JSON for flexibility)
  amenities         Json     @default("[]")
  houseRules        Json     @default("[]")
  
  // Images
  images            Json     @default("[]")
  
  // Status
  isActive          Boolean  @default(true)
  isApproved        Boolean  @default(false)
  
  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  host              User     @relation("HostRentals", fields: [hostId], references: [id])
  bookings          Booking[]
  reviews           Review[]
  
  @@index([hostId])
  @@index([isActive, isApproved])
  @@index([city, state])
}

enum PropertyType {
  HOUSE
  APARTMENT
  CONDO
  VILLA
  CABIN
  ESTATE
  OTHER
}

model Booking {
  id                String        @id @default(uuid())
  rentalId          String
  guestId           String
  
  // Dates
  checkInDate       DateTime
  checkOutDate      DateTime
  
  // Guests
  numberOfGuests    Int
  
  // Pricing Snapshot
  pricePerNight     Decimal       @db.Decimal(10, 2)
  numberOfNights    Int
  subtotal          Decimal       @db.Decimal(10, 2)
  cleaningFee       Decimal       @db.Decimal(10, 2)
  serviceFee        Decimal       @db.Decimal(10, 2)
  totalPrice        Decimal       @db.Decimal(10, 2)
  
  // Status
  status            BookingStatus @default(PENDING)
  
  // Special Requests
  guestMessage      String?
  
  // Metadata
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  cancelledAt       DateTime?
  cancellationReason String?
  
  // Relations
  rental            Rental        @relation(fields: [rentalId], references: [id])
  guest             User          @relation("GuestBookings", fields: [guestId], references: [id])
  reviews           Review[]
  
  @@index([rentalId])
  @@index([guestId])
  @@index([status])
  @@index([checkInDate, checkOutDate])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  DECLINED
}

model Review {
  id                String   @id @default(uuid())
  bookingId         String   
  rentalId          String
  authorId          String
  subjectId         String
  
  // Review Content
  rating            Int
  comment           String?
  
  // Review Type
  reviewType        ReviewType
  
  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  booking           Booking  @relation(fields: [bookingId], references: [id])
  rental            Rental   @relation(fields: [rentalId], references: [id])
  author            User     @relation("ReviewAuthor", fields: [authorId], references: [id])
  subject           User     @relation("ReviewSubject", fields: [subjectId], references: [id])
  
  @@unique([bookingId, authorId]) // Ensures one review per person per booking
  @@index([rentalId])
  @@index([authorId])
  @@index([subjectId])
}

enum ReviewType {
  GUEST_TO_HOST
  HOST_TO_GUEST
}

model Conversation {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Discovery & Context
  subject          String?   // Custom or Pre-defined subject line
  
  participantOneId String
  participantTwoId String

  participantOne   User @relation("ParticipantOne", fields: [participantOneId], references: [id])
  participantTwo   User @relation("ParticipantTwo", fields: [participantTwoId], references: [id])
  
  messages         Message[]
  
  @@unique([participantOneId, participantTwoId]) 
  @@index([participantOneId])
  @@index([participantTwoId])
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  senderId       String
  content        String?  // Optional if only sending attachments
  
  // Media
  attachments    Json     @default("[]") // [{ url: string, type: string, name: string }]
  
  readAt         DateTime?
  createdAt      DateTime @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id])
  sender         User         @relation("MessageSender", fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
}
